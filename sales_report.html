<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sales & Returns Report</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: linear-gradient(135deg, #111827, #1f2937);
      color: #f9fafb;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
    }
    .header-right {
      font-size: 12px;
      color: #d1d5db;
      display: flex;
      flex-direction: column;
      gap: 2px;
      text-align: right;
    }
    main {
      max-width: 1300px;
      margin: 18px auto 32px;
      padding: 0 16px 20px;
    }
    .info-note {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .status {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .status.error { color: #b91c1c; }
    .status.success { color: #059669; }

    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: flex-start;
      margin-bottom: 16px;
    }
    .filter-bar label {
      font-size: 12px;
      color: #4b5563;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .filter-bar select {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #f9fafb;
    }

    .style-filter {
      position: relative;
      min-width: 240px;
    }
    #filter-style {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      font-size: 12px;
      background: #ffffff;
    }
    #style-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 2px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      max-height: 220px;
      overflow-y: auto;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
      z-index: 20;
      font-size: 12px;
    }
    #style-suggestions div {
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
    }
    #style-suggestions div span {
      line-height: 1.2;
    }
    #style-suggestions div span.meta {
      color: #6b7280;
      font-size: 11px;
    }
    #style-suggestions div:hover {
      background: #eef2ff;
    }

    .kpi-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .kpi-card {
      background: white;
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .kpi-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .kpi-value {
      font-size: 18px;
      font-weight: 600;
      margin-top: 2px;
    }
    .kpi-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    section {
      margin-bottom: 26px;
    }
    section h2 {
      font-size: 16px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    section h2 span {
      font-size: 11px;
      font-weight: 500;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .card {
      background: white;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
      overflow: hidden;
    }
    .table-wrapper {
      max-height: 360px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
      min-width: 100%;
    }
    thead { position: sticky; top: 0; z-index: 1; }
    th, td {
      padding: 7px 8px;
      text-align: right;
      border-bottom: 1px solid #f3f4f6;
      white-space: nowrap;
    }
    th {
      background: #f9fafb;
      color: #4b5563;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 11px;
    }
    td:first-child, th:first-child { text-align: left; }
    tbody tr:nth-child(even) { background: #fcfcfd; }
    tbody tr:hover { background: #eef2ff; }

    .small-note {
      font-size: 11px;
      color: #6b7280;
      margin-top: 4px;
    }
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .chart-card {
      background: white;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.12);
    }
    .chart-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 6px;
      color: #374151;
    }
    canvas { max-height: 260px; }

    .top-styles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
  </style>
</head>
<body>
<header>
  <h1>Sales & Returns Report</h1>
  <div class="header-right">
    <span>Data source: CSV files from <strong>data/</strong> folder</span>
    <span>Loaded automatically (no upload needed)</span>
  </div>
</header>

<main>
  <p class="info-note">
    CSV files (multiple allowed) must contain a header row with:  
    <strong>
      ACCOUNT, Order ID, SKU, Uniware SKU, Style ID, Sizes, Event Type,
      Fulfilment Type, Order Date, Item Quantity,
      Price before discount, Customer's Delivery State, MP
    </strong>  
    Any extra lines <em>above</em> the header will be ignored.
  </p>

  <div id="status" class="status">Loading dataâ€¦</div>

  <!-- Filters -->
  <div class="filter-bar">
    <label>
      MP
      <select id="filter-mp">
        <option value="ALL">All MP</option>
      </select>
    </label>
    <label>
      Month
      <select id="filter-month">
        <option value="ALL">All Months</option>
      </select>
    </label>
    <label>
      Account
      <select id="filter-account">
        <option value="ALL">All Accounts</option>
      </select>
    </label>
    <label class="style-filter">
      Style / SKU search
      <input
        type="text"
        id="filter-style"
        placeholder="Type Style ID, SKU or Uniware SKU..."
      />
      <div id="style-suggestions"></div>
    </label>
  </div>

  <!-- KPI Summary -->
  <section>
    <h2>Overall Summary <span>Key metrics (after filters)</span></h2>

    <!-- Part 1: Values -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">GMV</div>
        <div class="kpi-value" id="kpi-total-revenue">â‚¹0</div>
        <div class="kpi-sub">Sale + Cancel + Return</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Net Revenue</div>
        <div class="kpi-value" id="kpi-net-revenue">â‚¹0</div>
        <div class="kpi-sub">Sales âˆ’ Returns</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Return Amount</div>
        <div class="kpi-value" id="kpi-return-amount">â‚¹0</div>
        <div class="kpi-sub">Value of return events</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Cancellation Amount</div>
        <div class="kpi-value" id="kpi-cancel-amount">â‚¹0</div>
        <div class="kpi-sub">Value of cancellation events</div>
      </div>
    </div>

    <!-- Part 2: Units & Orders -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Total Units Sold</div>
        <div class="kpi-value" id="kpi-total-qty">0</div>
        <div class="kpi-sub">Sale + Return + Cancel units</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Orders</div>
        <div class="kpi-value" id="kpi-total-orders">0</div>
        <div class="kpi-sub">Unique order IDs with sales</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Return Units</div>
        <div class="kpi-value" id="kpi-return-units">0</div>
        <div class="kpi-sub">Qty from returns</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Cancellation Units</div>
        <div class="kpi-value" id="kpi-cancel-units">0</div>
        <div class="kpi-sub">Qty from cancellations</div>
      </div>
    </div>

    <!-- Part 3: Ratios -->
    <div class="kpi-row">
      <div class="kpi-card">
        <div class="kpi-label">Return Amount %</div>
        <div class="kpi-value" id="kpi-return-amount-percent">0%</div>
        <div class="kpi-sub">Return amount / GMV</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Return Unit %</div>
        <div class="kpi-value" id="kpi-return-unit-percent">0%</div>
        <div class="kpi-sub">Return units / total units</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Cancellation %</div>
        <div class="kpi-value" id="kpi-cancel-percent">0%</div>
        <div class="kpi-sub">Cancel units / total units</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">FBF Share</div>
        <div class="kpi-value" id="kpi-fbf-share">0%</div>
        <div class="kpi-sub">Of total sale quantity</div>
      </div>
    </div>
  </section>

  <!-- Account-wise Sales -->
  <section>
    <h2>Account-wise Sales <span>ACCOUNT column</span></h2>
    <div class="card">
      <div class="table-wrapper">
        <table id="table-account">
          <thead>
          <tr>
            <th>Account</th>
            <th>Total Units Sold</th>
            <th>GMV</th>
            <th>Return Qty</th>
            <th>Return Amount</th>
            <th>Cancellation Units</th>
            <th>Cancellation Amount</th>
            <th>Net Qty</th>
            <th>Net Amount</th>
            <th>Return %</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MP-wise Sales -->
  <section>
    <h2>MP-wise Sales <span>Marketplace performance</span></h2>
    <div class="card">
      <div class="table-wrapper">
        <table id="table-mp">
          <thead>
          <tr>
            <th>MP</th>
            <th>Total Units Sold</th>
            <th>GMV</th>
            <th>Return Qty</th>
            <th>Return Amount</th>
            <th>Cancellation Units</th>
            <th>Cancellation Amount</th>
            <th>Net Qty</th>
            <th>Net Amount</th>
            <th>Return %</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CHARTS -->
  <section>
    <h2>Charts Overview <span>Visual insights</span></h2>
    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-title">MP Share (GMV)</div>
        <canvas id="chart-mp"></canvas>
      </div>
      <div class="chart-card">
        <div class="chart-title">Qty by Fulfilment Type (Sales Qty)</div>
        <canvas id="chart-fulfilment"></canvas>
      </div>
    </div>
  </section>

  <!-- Sales by Fulfilment & MP -->
  <section>
    <h2>Sales by Fulfilment & MP <span>FBF vs NON_FBF by marketplace</span></h2>
    <div class="card">
      <div class="table-wrapper">
        <table id="table-fulfilment">
          <thead>
          <tr>
            <th>Fulfilment Type</th>
            <th>MP</th>
            <th>Total Units Sold</th>
            <th>GMV</th>
            <th>Return Qty</th>
            <th>Return Amount</th>
            <th>Net Qty</th>
            <th>Net Amount</th>
            <th>Return %</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="small-note">
        Sales = Event Type contains "Sale". Returns = Event Type contains "Return". Cancellations = Event Type contains "Cancel".
      </div>
    </div>
  </section>

  <!-- State-wise -->
  <section>
    <h2>State-wise Sales <span>Customer's Delivery State</span></h2>
    <div class="card">
      <div class="table-wrapper">
        <table id="table-state">
          <thead>
          <tr>
            <th>Customer State</th>
            <th>Total Units Sold</th>
            <th>GMV</th>
            <th>Return Qty</th>
            <th>Return Amount</th>
            <th>Net Qty</th>
            <th>Net Amount</th>
            <th>Return %</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Style ID Performance -->
  <section>
    <h2>Style Performance <span>Style ID wise summary</span></h2>
    <div class="card">
      <div class="table-wrapper">
        <table id="table-sku">
          <thead>
          <tr>
            <th>Style ID</th>
            <th>Total Units Sold</th>
            <th>GMV</th>
            <th>Return Qty</th>
            <th>Return Amount</th>
            <th>Net Qty</th>
            <th>Net Amount</th>
            <th>Return %</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Top Styles Section -->
  <section>
    <h2>Top Styles (Filtered View) <span>Top 10 by units / GMV / returns</span></h2>
    <div class="card">
      <div class="top-styles-grid">
        <div>
          <h3 style="font-size:13px;margin:0 0 4px;">Top 10 Styles by Units</h3>
          <div class="table-wrapper">
            <table id="table-top-style-units">
              <thead>
              <tr>
                <th>#</th>
                <th>Style ID</th>
                <th>Total Units Sold</th>
                <th>Return Qty</th>
                <th>Return %</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 style="font-size:13px;margin:0 0 4px;">Top 10 Styles by GMV</h3>
          <div class="table-wrapper">
            <table id="table-top-style-revenue">
              <thead>
              <tr>
                <th>#</th>
                <th>Style ID</th>
                <th>GMV</th>
                <th>Net Amount</th>
                <th>Return %</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3 style="font-size:13px;margin:0 0 4px;">Top 10 Styles by Returns (Qty)</h3>
          <div class="table-wrapper">
            <table id="table-top-style-returns">
              <thead>
              <tr>
                <th>#</th>
                <th>Style ID</th>
                <th>Return Qty</th>
                <th>Return Amount</th>
                <th>Return %</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="small-note">
        These top lists respect the MP, Month, Account and Style/SKU filters above.
      </div>
    </div>
  </section>
</main>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ðŸ”¹ 1. List of CSV files to load from GitHub (edit this for your repo)
  const DATA_FILES = [
    "data/orders_jan.csv",
    "data/orders_feb.csv",
    // add more files here, e.g. "data/orders_mar.csv"
  ];

  const statusEl = document.getElementById("status");
  const filterMpEl = document.getElementById("filter-mp");
  const filterMonthEl = document.getElementById("filter-month");
  const filterAccountEl = document.getElementById("filter-account");
  const filterStyleEl = document.getElementById("filter-style");
  const styleSuggestionsEl = document.getElementById("style-suggestions");

  let rawRows = [];
  let charts = {
    mp: null,
    fulfilment: null
  };
  let styleFilterText = "";

  function setStatus(msg, type = "") {
    statusEl.textContent = msg;
    statusEl.className = "status";
    if (type) statusEl.classList.add(type);
  }

  // ðŸ”¹ 2. Safe CSV parser: finds real header row & ignores junk above it
  function parseCSVSafe(text) {
    const lines = text
      .split(/\r?\n/)
      .map((l) => l.trim())
      .filter((l) => l.length > 0);

    if (lines.length < 2) return [];

    // Find header line (must contain Order ID and Style ID)
    let headerIndex = -1;
    for (let i = 0; i < lines.length; i++) {
      const low = lines[i].toLowerCase();
      if (low.includes("order id") && low.includes("style id")) {
        headerIndex = i;
        break;
      }
    }
    if (headerIndex === -1) {
      return [];
    }

    const headers = lines[headerIndex].split(",").map((h) => h.trim());
    const rows = [];

    for (let i = headerIndex + 1; i < lines.length; i++) {
      const parts = lines[i].split(",");
      if (!parts.length) continue;
      const row = {};
      headers.forEach((h, idx) => {
        row[h] = (parts[idx] || "").trim();
      });
      rows.push(row);
    }
    return rows;
  }

  function toNumber(value) {
    if (value === undefined || value === null) return 0;
    const cleaned = String(value).replace(/[^0-9.-]/g, "");
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
  }

  function formatNumber(x) {
    return x.toLocaleString("en-IN", {
      maximumFractionDigits: 0,
    });
  }

  function formatMoney(x) {
    return "â‚¹" +
      x.toLocaleString("en-IN", {
        maximumFractionDigits: 0,
      });
  }

  function formatPercent(value) {
    if (!isFinite(value)) return "0%";
    return (value * 100).toFixed(1) + "%";
  }

  function groupKey(row, keys) {
    return keys.map((k) => (row[k] || "").toString().trim()).join("||");
  }

  function safeSplitKey(key) {
    return key.split("||");
  }

  function aggregateBy(rows, keys) {
    const map = new Map();
    for (const row of rows) {
      const key = groupKey(row, keys);
      const qty = toNumber(row["Item Quantity"]);
      const price = toNumber(row["Price before discount"]);
      const amount = qty * price;
      const orderId = row["Order ID"] || "";
      if (!map.has(key)) {
        map.set(key, {
          qty: 0,
          amount: 0,
          orders: new Set(),
        });
      }
      const obj = map.get(key);
      obj.qty += qty;
      obj.amount += amount;
      if (orderId) obj.orders.add(orderId);
    }
    return map;
  }

  function renderTable(tableId, rows, columns) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    tbody.innerHTML = "";
    if (!rows || rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = columns.length;
      td.textContent = "No data.";
      td.style.textAlign = "center";
      td.style.color = "#9ca3af";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    for (const row of rows) {
      const tr = document.createElement("tr");
      for (const col of columns) {
        const td = document.createElement("td");
        td.textContent = row[col] ?? "";
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }
  }

  function createOrUpdateChart(key, ctxId, configMaker) {
    if (charts[key]) {
      charts[key].destroy();
    }
    const ctx = document.getElementById(ctxId);
    if (!ctx) return;
    const config = configMaker();
    if (!config) return;
    charts[key] = new Chart(ctx, config);
  }

  // DD-MM-YYYY parsing â†’ month key YYYY-MM
  function monthKeyFromDateStr(dateStr) {
    if (!dateStr) return null;
    const s = String(dateStr).trim();
    if (!s) return null;
    const m = s.match(/^(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})$/);
    let year, month;
    if (m) {
      const dd = parseInt(m[1], 10);
      const mm = parseInt(m[2], 10);
      const yyyy = parseInt(m[3], 10);
      if (!yyyy || !mm || mm < 1 || mm > 12 || !dd || dd < 1 || dd > 31) {
        return null;
      }
      year = yyyy;
      month = mm;
    } else {
      const d = new Date(s);
      if (isNaN(d.getTime())) return null;
      year = d.getFullYear();
      month = d.getMonth() + 1;
    }
    return `${year}-${String(month).padStart(2, "0")}`;
  }

  function monthLabel(ym) {
    const [y, m] = ym.split("-");
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul",
                        "Aug", "Sep", "Oct", "Nov", "Dec"];
    const idx = parseInt(m, 10) - 1;
    const mn = monthNames[idx] || m;
    return `${mn} ${y}`;
  }

  function initFilters(rows) {
    // MP filter
    const mpSet = new Set();
    rows.forEach(r => {
      const mp = (r["MP"] || "").trim();
      if (mp) mpSet.add(mp);
    });
    const mpOptions = ["ALL", ...Array.from(mpSet).sort()];
    filterMpEl.innerHTML = "";
    mpOptions.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v === "ALL" ? "All MP" : v;
      filterMpEl.appendChild(opt);
    });

    // Month filter
    const monthSet = new Set();
    rows.forEach(r => {
      const mk = monthKeyFromDateStr(r["Order Date"]);
      if (mk) monthSet.add(mk);
    });
    const monthList = Array.from(monthSet).sort();
    filterMonthEl.innerHTML = "";
    const optAll = document.createElement("option");
    optAll.value = "ALL";
    optAll.textContent = "All Months";
    filterMonthEl.appendChild(optAll);
    monthList.forEach(mk => {
      const opt = document.createElement("option");
      opt.value = mk;
      opt.textContent = monthLabel(mk);
      filterMonthEl.appendChild(opt);
    });

    // Account filter
    const accSet = new Set();
    rows.forEach(r => {
      const acc = (r["ACCOUNT"] || "").trim();
      if (acc) accSet.add(acc);
    });
    const accOptions = ["ALL", ...Array.from(accSet).sort()];
    filterAccountEl.innerHTML = "";
    accOptions.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v === "ALL" ? "All Accounts" : v;
      filterAccountEl.appendChild(opt);
    });
  }

  function getFilteredRows() {
    let rows = rawRows.slice();
    const mpVal = filterMpEl.value || "ALL";
    const monthVal = filterMonthEl.value || "ALL";
    const accVal = filterAccountEl.value || "ALL";

    if (mpVal !== "ALL") {
      rows = rows.filter(r => (r["MP"] || "").trim() === mpVal);
    }
    if (monthVal !== "ALL") {
      rows = rows.filter(r => monthKeyFromDateStr(r["Order Date"]) === monthVal);
    }
    if (accVal !== "ALL") {
      rows = rows.filter(r => (r["ACCOUNT"] || "").trim() === accVal);
    }
    if (styleFilterText.trim() !== "") {
      const q = styleFilterText.trim().toLowerCase();
      rows = rows.filter(r => {
        const style = String(r["Style ID"] || "").toLowerCase();
        const sku = String(r["SKU"] || "").toLowerCase();
        const uSku = String(r["Uniware SKU"] || "").toLowerCase();
        return (
          style.includes(q) ||
          sku.includes(q) ||
          uSku.includes(q)
        );
      });
    }
    return rows;
  }

  function updateStyleSuggestions(query) {
    styleSuggestionsEl.innerHTML = "";
    const q = query.trim().toLowerCase();
    if (!q || q.length < 2 || !rawRows.length) return;

    const seen = new Set();
    const suggestions = [];
    for (const r of rawRows) {
      const style = (r["Style ID"] || "").trim();
      const sku = (r["SKU"] || "").trim();
      const uSku = (r["Uniware SKU"] || "").trim();

      const comboText = `${style} ${sku} ${uSku}`.toLowerCase();
      if (!comboText.includes(q)) continue;

      const key = `${style}||${sku}||${uSku}`;
      if (seen.has(key)) continue;
      seen.add(key);
      suggestions.push({ style, sku, uSku });
      if (suggestions.length >= 20) break;
    }

    if (!suggestions.length) return;

    suggestions.forEach((s) => {
      const div = document.createElement("div");
      const main = document.createElement("span");
      main.textContent = s.style || s.sku || s.uSku || "(blank)";
      const meta = document.createElement("span");
      meta.className = "meta";
      meta.textContent = `Style: ${s.style || "-"} | SKU: ${s.sku || "-"} | Uniware: ${s.uSku || "-"}`;
      div.appendChild(main);
      div.appendChild(meta);

      div.addEventListener("click", () => {
        const chosen = s.style || s.sku || s.uSku || "";
        filterStyleEl.value = chosen;
        styleFilterText = chosen;
        styleSuggestionsEl.innerHTML = "";
        if (!rawRows.length) return;
        const rows = getFilteredRows();
        computeAndRender(rows);
      });

      styleSuggestionsEl.appendChild(div);
    });
  }

  function computeAndRender(rows) {
    if (!rows || rows.length === 0) {
      setStatus("No rows found for current filter.", "error");
      [
        "table-account","table-mp","table-fulfilment","table-state","table-sku",
        "table-top-style-units","table-top-style-revenue","table-top-style-returns"
      ].forEach(id => {
        const tbody = document.querySelector(`#${id} tbody`);
        tbody.innerHTML = "";
      });
      Object.keys(charts).forEach(k => {
        if (charts[k]) {
          charts[k].destroy();
          charts[k] = null;
        }
      });
      document.getElementById("kpi-total-revenue").textContent = "â‚¹0";
      document.getElementById("kpi-net-revenue").textContent = "â‚¹0";
      document.getElementById("kpi-return-amount").textContent = "â‚¹0";
      document.getElementById("kpi-cancel-amount").textContent = "â‚¹0";
      document.getElementById("kpi-total-qty").textContent = "0";
      document.getElementById("kpi-total-orders").textContent = "0";
      document.getElementById("kpi-return-units").textContent = "0";
      document.getElementById("kpi-cancel-units").textContent = "0";
      document.getElementById("kpi-return-amount-percent").textContent = "0%";
      document.getElementById("kpi-return-unit-percent").textContent = "0%";
      document.getElementById("kpi-cancel-percent").textContent = "0%";
      document.getElementById("kpi-fbf-share").textContent = "0%";
      return;
    }

    const lower = (v) => String(v || "").toLowerCase();

    const sales = [];
    const returns = [];
    const cancels = [];

    for (const row of rows) {
      const et = lower(row["Event Type"]);
      const isSale = et.includes("sale");
      const isReturn = et.includes("return");
      const isCancel = et.includes("cancel");

      if (isSale) sales.push(row);
      if (isReturn) returns.push(row);
      if (isCancel) cancels.push(row);
    }

    // === KPI Summary ===
    const totalSaleQty = sales.reduce(
      (sum, r) => sum + toNumber(r["Item Quantity"]),
      0
    );
    const totalSaleAmount = sales.reduce((sum, r) => {
      const qty = toNumber(r["Item Quantity"]);
      const price = toNumber(r["Price before discount"]);
      return sum + qty * price;
    }, 0);

    const totalReturnQty = returns.reduce(
      (sum, r) => sum + toNumber(r["Item Quantity"]),
      0
    );
    const totalReturnAmount = returns.reduce((sum, r) => {
      const qty = toNumber(r["Item Quantity"]);
      const price = toNumber(r["Price before discount"]);
      return sum + qty * price;
    }, 0);

    const cancelQty = cancels.reduce(
      (sum, r) => sum + toNumber(r["Item Quantity"]),
      0
    );
    const cancelAmount = cancels.reduce((sum, r) => {
      const qty = toNumber(r["Item Quantity"]);
      const price = toNumber(r["Price before discount"]);
      return sum + qty * price;
    }, 0);

    const gmvAmount = totalSaleAmount + totalReturnAmount + cancelAmount;
    const netRevenue = totalSaleAmount - totalReturnAmount;

    const totalUnits = totalSaleQty + totalReturnQty + cancelQty;

    const orderSet = new Set(
      sales
        .map((r) => r["Order ID"])
        .filter((v) => v !== undefined && v !== null && String(v).trim() !== "")
    );
    const totalOrders = orderSet.size;

    const returnAmountPercent = gmvAmount ? totalReturnAmount / gmvAmount : 0;
    const returnUnitPercent = totalUnits ? totalReturnQty / totalUnits : 0;
    const cancelPercent = totalUnits ? cancelQty / totalUnits : 0;

    // FBF share (on sales)
    const fbfQty = sales
      .filter((r) => lower(r["Fulfilment Type"]) === "fbf")
      .reduce((sum, r) => sum + toNumber(r["Item Quantity"]), 0);
    const fbfShare = totalSaleQty ? fbfQty / totalSaleQty : 0;

    // Set KPIs
    document.getElementById("kpi-total-revenue").textContent =
      formatMoney(gmvAmount);
    document.getElementById("kpi-net-revenue").textContent =
      formatMoney(netRevenue);
    document.getElementById("kpi-return-amount").textContent =
      formatMoney(totalReturnAmount);
    document.getElementById("kpi-cancel-amount").textContent =
      formatMoney(cancelAmount);

    document.getElementById("kpi-total-qty").textContent =
      formatNumber(totalUnits);
    document.getElementById("kpi-total-orders").textContent =
      formatNumber(totalOrders);
    document.getElementById("kpi-return-units").textContent =
      formatNumber(totalReturnQty);
    document.getElementById("kpi-cancel-units").textContent =
      formatNumber(cancelQty);

    document.getElementById("kpi-return-amount-percent").textContent =
      formatPercent(returnAmountPercent);
    document.getElementById("kpi-return-unit-percent").textContent =
      formatPercent(returnUnitPercent);
    document.getElementById("kpi-cancel-percent").textContent =
      formatPercent(cancelPercent);
    document.getElementById("kpi-fbf-share").textContent =
      formatPercent(fbfShare);

    // === Aggregations helper for sale+return only ===
    function buildCombinedTable(saleMap, returnMap, labelBuilder) {
      const combined = [];
      const allKeys = new Set([
        ...Array.from(saleMap.keys()),
        ...Array.from(returnMap.keys()),
      ]);

      for (const key of allKeys) {
        const saleEntry = saleMap.get(key) || {
          qty: 0,
          amount: 0,
          orders: new Set(),
        };
        const returnEntry = returnMap.get(key) || {
          qty: 0,
          amount: 0,
          orders: new Set(),
        };
        const labels = labelBuilder(key);
        const saleQty = saleEntry.qty;
        const saleAmt = saleEntry.amount;
        const returnQty = returnEntry.qty;
        const returnAmt = returnEntry.amount;
        const netQty = saleQty - returnQty;
        const netAmt = saleAmt - returnAmt;
        const retPct = saleQty ? returnQty / saleQty : 0;

        const orders = new Set([
          ...Array.from(saleEntry.orders),
          ...Array.from(returnEntry.orders),
        ]);

        combined.push({
          key,
          labels,
          saleQty,
          saleAmt,
          returnQty,
          returnAmt,
          netQty,
          netAmt,
          retPct,
          ordersCount: orders.size,
        });
      }

      combined.sort((a, b) => b.saleAmt - a.saleAmt);
      return combined;
    }

    // Fulfilment & MP table (with GMV & total units)
    const saleFulMp = aggregateBy(sales, ["Fulfilment Type", "MP"]);
    const returnFulMp = aggregateBy(returns, ["Fulfilment Type", "MP"]);
    const cancelFulMp = aggregateBy(cancels, ["Fulfilment Type", "MP"]);

    const fulCombined = buildCombinedTable(
      saleFulMp,
      returnFulMp,
      (key) => {
        const [f, mp] = safeSplitKey(key);
        return [f || "-", mp || "-"];
      }
    );

    const rowsFul = fulCombined.map((r) => {
      const cancelEntry = cancelFulMp.get(r.key) || {
        qty: 0,
        amount: 0,
        orders: new Set()
      };
      const totalUnitsLocal = r.saleQty + r.returnQty + cancelEntry.qty;
      const gmvLocal = r.saleAmt + r.returnAmt + cancelEntry.amount;
      return {
        "Fulfilment Type": r.labels[0],
        "MP": r.labels[1],
        "Total Units Sold": formatNumber(totalUnitsLocal),
        "GMV": formatMoney(gmvLocal),
        "Return Qty": formatNumber(r.returnQty),
        "Return Amount": formatMoney(r.returnAmt),
        "Net Qty": formatNumber(r.netQty),
        "Net Amount": formatMoney(r.netAmt),
        "Return %": formatPercent(r.retPct),
      };
    });

    renderTable("table-fulfilment", rowsFul, [
      "Fulfilment Type",
      "MP",
      "Total Units Sold",
      "GMV",
      "Return Qty",
      "Return Amount",
      "Net Qty",
      "Net Amount",
      "Return %",
    ]);

    // State-wise (with GMV & total units)
    const saleState = aggregateBy(sales, ["Customer's Delivery State"]);
    const returnState = aggregateBy(returns, ["Customer's Delivery State"]);
    const cancelState = aggregateBy(cancels, ["Customer's Delivery State"]);

    const rowsStateCombined = buildCombinedTable(
      saleState,
      returnState,
      (key) => {
        const [state] = safeSplitKey(key);
        return [state || "-"];
      }
    );

    const rowsState = rowsStateCombined.map((r) => {
      const cancelEntry = cancelState.get(r.key) || {
        qty: 0,
        amount: 0,
        orders: new Set()
      };
      const totalUnitsLocal = r.saleQty + r.returnQty + cancelEntry.qty;
      const gmvLocal = r.saleAmt + r.returnAmt + cancelEntry.amount;
      return {
        "Customer State": r.labels[0],
        "Total Units Sold": formatNumber(totalUnitsLocal),
        "GMV": formatMoney(gmvLocal),
        "Return Qty": formatNumber(r.returnQty),
        "Return Amount": formatMoney(r.returnAmt),
        "Net Qty": formatNumber(r.netQty),
        "Net Amount": formatMoney(r.netAmt),
        "Return %": formatPercent(r.retPct),
      };
    });

    renderTable("table-state", rowsState, [
      "Customer State",
      "Total Units Sold",
      "GMV",
      "Return Qty",
      "Return Amount",
      "Net Qty",
      "Net Amount",
      "Return %",
    ]);

    // Style Performance (Style ID, with GMV & total units)
    const saleStyle = aggregateBy(sales, ["Style ID"]);
    const returnStyle = aggregateBy(returns, ["Style ID"]);
    const cancelStyle = aggregateBy(cancels, ["Style ID"]);

    const styleCombined = buildCombinedTable(
      saleStyle,
      returnStyle,
      (key) => {
        const [style] = safeSplitKey(key);
        return [style || "-"];
      }
    );

    const styleWithTotals = styleCombined.map((r) => {
      const cancelEntry = cancelStyle.get(r.key) || {
        qty: 0,
        amount: 0,
        orders: new Set()
      };
      const totalUnitsLocal = r.saleQty + r.returnQty + cancelEntry.qty;
      const gmvLocal = r.saleAmt + r.returnAmt + cancelEntry.amount;
      return { ...r, totalUnitsLocal, gmvLocal };
    });

    const rowsSku = styleWithTotals.map((r) => ({
      "Style ID": r.labels[0],
      "Total Units Sold": formatNumber(r.totalUnitsLocal),
      "GMV": formatMoney(r.gmvLocal),
      "Return Qty": formatNumber(r.returnQty),
      "Return Amount": formatMoney(r.returnAmt),
      "Net Qty": formatNumber(r.netQty),
      "Net Amount": formatNumber(r.netAmt),
      "Return %": formatPercent(r.retPct),
    }));

    renderTable("table-sku", rowsSku, [
      "Style ID",
      "Total Units Sold",
      "GMV",
      "Return Qty",
      "Return Amount",
      "Net Qty",
      "Net Amount",
      "Return %",
    ]);

    // MP-wise (with GMV & cancellation)
    const saleMP = aggregateBy(sales, ["MP"]);
    const returnMP = aggregateBy(returns, ["MP"]);
    const cancelMP = aggregateBy(cancels, ["MP"]);

    const mpRowsCombined = [];
    const allMpKeys = new Set([
      ...Array.from(saleMP.keys()),
      ...Array.from(returnMP.keys()),
      ...Array.from(cancelMP.keys()),
    ]);

    for (const key of allMpKeys) {
      const saleEntry = saleMP.get(key) || { qty: 0, amount: 0, orders: new Set() };
      const returnEntry = returnMP.get(key) || { qty: 0, amount: 0, orders: new Set() };
      const cancelEntry = cancelMP.get(key) || { qty: 0, amount: 0, orders: new Set() };

      const saleQty = saleEntry.qty;
      const saleAmt = saleEntry.amount;
      const returnQty = returnEntry.qty;
      const returnAmt = returnEntry.amount;
      const cancelQtyLocal = cancelEntry.qty;
      const cancelAmtLocal = cancelEntry.amount;

      const totalUnitsLocal = saleQty + returnQty + cancelQtyLocal;
      const gmvLocal = saleAmt + returnAmt + cancelAmtLocal;

      const netQty = saleQty - returnQty;
      const netAmt = saleAmt - returnAmt;
      const retPct = saleQty ? returnQty / saleQty : 0;

      const [mpLabel] = safeSplitKey(key);

      mpRowsCombined.push({
        mp: mpLabel || "-",
        totalUnitsLocal,
        gmvLocal,
        returnQty,
        returnAmt,
        cancelQtyLocal,
        cancelAmtLocal,
        netQty,
        netAmt,
        retPct
      });
    }

    mpRowsCombined.sort((a, b) => b.gmvLocal - a.gmvLocal);

    const rowsMP = mpRowsCombined.map(r => ({
      "MP": r.mp,
      "Total Units Sold": formatNumber(r.totalUnitsLocal),
      "GMV": formatMoney(r.gmvLocal),
      "Return Qty": formatNumber(r.returnQty),
      "Return Amount": formatMoney(r.returnAmt),
      "Cancellation Units": formatNumber(r.cancelQtyLocal),
      "Cancellation Amount": formatMoney(r.cancelAmtLocal),
      "Net Qty": formatNumber(r.netQty),
      "Net Amount": formatMoney(r.netAmt),
      "Return %": formatPercent(r.retPct),
    }));

    renderTable("table-mp", rowsMP, [
      "MP",
      "Total Units Sold",
      "GMV",
      "Return Qty",
      "Return Amount",
      "Cancellation Units",
      "Cancellation Amount",
      "Net Qty",
      "Net Amount",
      "Return %",
    ]);

    // Account-wise (with GMV & cancellation)
    const saleAccount = aggregateBy(sales, ["ACCOUNT"]);
    const returnAccount = aggregateBy(returns, ["ACCOUNT"]);
    const cancelAccount = aggregateBy(cancels, ["ACCOUNT"]);

    const accRowsCombined = [];
    const allAccKeys = new Set([
      ...Array.from(saleAccount.keys()),
      ...Array.from(returnAccount.keys()),
      ...Array.from(cancelAccount.keys()),
    ]);

    for (const key of allAccKeys) {
      const saleEntry = saleAccount.get(key) || { qty: 0, amount: 0, orders: new Set() };
      const returnEntry = returnAccount.get(key) || { qty: 0, amount: 0, orders: new Set() };
      const cancelEntry = cancelAccount.get(key) || { qty: 0, amount: 0, orders: new Set() };

      const saleQty = saleEntry.qty;
      const saleAmt = saleEntry.amount;
      const returnQty = returnEntry.qty;
      const returnAmt = returnEntry.amount;
      const cancelQtyLocal = cancelEntry.qty;
      const cancelAmtLocal = cancelEntry.amount;

      const totalUnitsLocal = saleQty + returnQty + cancelQtyLocal;
      const gmvLocal = saleAmt + returnAmt + cancelAmtLocal;

      const netQty = saleQty - returnQty;
      const netAmt = saleAmt - returnAmt;
      const retPct = saleQty ? returnQty / saleQty : 0;

      const [accLabel] = safeSplitKey(key);

      accRowsCombined.push({
        acc: accLabel || "-",
        totalUnitsLocal,
        gmvLocal,
        returnQty,
        returnAmt,
        cancelQtyLocal,
        cancelAmtLocal,
        netQty,
        netAmt,
        retPct
      });
    }

    accRowsCombined.sort((a, b) => b.gmvLocal - a.gmvLocal);

    const rowsAccount = accRowsCombined.map(r => ({
      "Account": r.acc,
      "Total Units Sold": formatNumber(r.totalUnitsLocal),
      "GMV": formatMoney(r.gmvLocal),
      "Return Qty": formatNumber(r.returnQty),
      "Return Amount": formatMoney(r.returnAmt),
      "Cancellation Units": formatNumber(r.cancelQtyLocal),
      "Cancellation Amount": formatMoney(r.cancelAmtLocal),
      "Net Qty": formatNumber(r.netQty),
      "Net Amount": formatMoney(r.netAmt),
      "Return %": formatPercent(r.retPct),
    }));

    renderTable("table-account", rowsAccount, [
      "Account",
      "Total Units Sold",
      "GMV",
      "Return Qty",
      "Return Amount",
      "Cancellation Units",
      "Cancellation Amount",
      "Net Qty",
      "Net Amount",
      "Return %",
    ]);

    // === Top styles tables using totalUnitsLocal & gmvLocal ===
    const topByUnits = [...styleWithTotals]
      .sort((a, b) => b.totalUnitsLocal - a.totalUnitsLocal)
      .slice(0, 10);
    const topByRevenue = [...styleWithTotals]
      .sort((a, b) => b.gmvLocal - a.gmvLocal)
      .slice(0, 10);
    const topByReturns = [...styleWithTotals]
      .sort((a, b) => b.returnQty - a.returnQty)
      .slice(0, 10);

    const rowsTopUnits = topByUnits.map((r, idx) => ({
      "#": idx + 1,
      "Style ID": r.labels[0],
      "Total Units Sold": formatNumber(r.totalUnitsLocal),
      "Return Qty": formatNumber(r.returnQty),
      "Return %": formatPercent(r.retPct),
    }));
    renderTable("table-top-style-units", rowsTopUnits, [
      "#",
      "Style ID",
      "Total Units Sold",
      "Return Qty",
      "Return %",
    ]);

    const rowsTopRevenue = topByRevenue.map((r, idx) => ({
      "#": idx + 1,
      "Style ID": r.labels[0],
      "GMV": formatMoney(r.gmvLocal),
      "Net Amount": formatMoney(r.netAmt),
      "Return %": formatPercent(r.retPct),
    }));
    renderTable("table-top-style-revenue", rowsTopRevenue, [
      "#",
      "Style ID",
      "GMV",
      "Net Amount",
      "Return %",
    ]);

    const rowsTopReturns = topByReturns.map((r, idx) => ({
      "#": idx + 1,
      "Style ID": r.labels[0],
      "Return Qty": formatNumber(r.returnQty),
      "Return Amount": formatMoney(r.returnAmt),
      "Return %": formatPercent(r.retPct),
    }));
    renderTable("table-top-style-returns", rowsTopReturns, [
      "#",
      "Style ID",
      "Return Qty",
      "Return Amount",
      "Return %",
    ]);

    // === CHARTS ===

    // MP Share (GMV) â€“ doughnut
    createOrUpdateChart("mp", "chart-mp", () => {
      if (!rowsMP.length) return null;
      const labels = rowsMP.map(r => r["MP"]);
      const data = rowsMP.map(r => {
        const v = r["GMV"].replace(/[â‚¹,]/g, "");
        return parseFloat(v) || 0;
      });
      return {
        type: "doughnut",
        data: {
          labels,
          datasets: [{ data }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "bottom" },
            tooltip: {
              callbacks: {
                label: ctx => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const val = ctx.parsed;
                  const share = total ? (val / total) * 100 : 0;
                  return `${ctx.label}: â‚¹${val.toLocaleString("en-IN")} (${share.toFixed(1)}%)`;
                }
              }
            }
          }
        }
      };
    });

    // Fulfilment Qty chart (sum by Fulfilment Type across all MPs, sales qty only)
    createOrUpdateChart("fulfilment", "chart-fulfilment", () => {
      if (!rowsFul.length) return null;
      const agg = new Map();
      rowsFul.forEach(r => {
        const f = r["Fulfilment Type"];
        const net = parseFloat((r["Net Qty"] || "0").replace(/,/g, "")) || 0;
        const ret = parseFloat((r["Return Qty"] || "0").replace(/,/g, "")) || 0;
        const qty = net + ret; // approx sale qty
        agg.set(f, (agg.get(f) || 0) + qty);
      });
      const labels = Array.from(agg.keys());
      const data = Array.from(agg.values());
      return {
        type: "doughnut",
        data: { labels, datasets: [{ data }] },
        options: {
          responsive: true,
          plugins: { legend: { position: "bottom" } }
        }
      };
    });

    setStatus(
      `Report generated from ${rows.length} rows (filtered) out of ${rawRows.length} total loaded.`,
      "success"
    );
  }

  // ðŸ”¹ 3. Load all CSV files from DATA_FILES on page load
  function loadAllDataFromGithub() {
    if (!DATA_FILES.length) {
      setStatus("No CSV files configured in DATA_FILES.", "error");
      return;
    }
    setStatus("Loading data from CSV filesâ€¦");

    Promise.all(
      DATA_FILES.map((path) =>
        fetch(path).then((res) => {
          if (!res.ok) throw new Error("Failed to load " + path);
          return res.text();
        })
      )
    )
      .then((texts) => {
        let allRows = [];
        texts.forEach((txt, index) => {
          const rows = parseCSVSafe(txt);
          allRows = allRows.concat(rows);
        });

        rawRows = allRows;
        if (!rawRows.length) {
          setStatus("No valid rows found in any CSV.", "error");
          return;
        }

        initFilters(rawRows);
        styleFilterText = "";
        filterStyleEl.value = "";
        styleSuggestionsEl.innerHTML = "";
        const filteredRows = getFilteredRows();
        computeAndRender(filteredRows);
        setStatus(
          `Loaded ${rawRows.length.toLocaleString("en-IN")} rows from ${DATA_FILES.length} file(s).`,
          "success"
        );
      })
      .catch((err) => {
        console.error(err);
        setStatus("Error loading CSV files. Check file paths & GitHub setup.", "error");
      });
  }

  // Filter events
  filterMpEl.addEventListener("change", () => {
    if (!rawRows.length) return;
    const rows = getFilteredRows();
    computeAndRender(rows);
  });

  filterMonthEl.addEventListener("change", () => {
    if (!rawRows.length) return;
    const rows = getFilteredRows();
    computeAndRender(rows);
  });

  filterAccountEl.addEventListener("change", () => {
    if (!rawRows.length) return;
    const rows = getFilteredRows();
    computeAndRender(rows);
  });

  filterStyleEl.addEventListener("input", () => {
    styleFilterText = filterStyleEl.value || "";
    updateStyleSuggestions(styleFilterText);
    if (!rawRows.length) return;
    const rows = getFilteredRows();
    computeAndRender(rows);
  });

  document.addEventListener("click", (e) => {
    if (!styleSuggestionsEl.contains(e.target) && e.target !== filterStyleEl) {
      styleSuggestionsEl.innerHTML = "";
    }
  });

  // ðŸ”¹ Start loading once page is ready
  document.addEventListener("DOMContentLoaded", loadAllDataFromGithub);
</script>
</body>
</html>
